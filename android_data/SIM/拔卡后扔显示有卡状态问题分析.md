---
title: 拔掉SIM卡后仍显示有卡状态
date: 2017-04-02 10:12:04
tags: android
categories:
    - BUG
    - SIM
password: 
---

# 问题描述

```
SIM卡拔出来，仍然显示有卡状态
```

# 问题分析

## 问题发生时间点

**第一次插卡**
00 ---51:21 插卡 modem 10s识别-51:32

**拔卡**
027---51:48 拔卡

**再次插卡恢复**
2:56--54:09 插

问题发生时间就是在51:48~54:09

## 关键LOG

**SIM卡状态**

## 问题结论

从提供的`QXDM`LOG来看，底层对`SIM`的状态判断没有问题，只是在上报的时候有延时，虽然在
```
10-11 09:51:44.409 2177 2177 D PhoneSwitcher: mSimStateIntentReceiver: phoneId = 0 value = READY
```


# 知识点总结

`frameworks/opt/telephony/src/java/com/android/internal/telephony/uicc/UiccController.java`
这个类可以收到底层上报的`SIM`状态变化的消息，然后上层会去查询`SIM`卡的状态

在创建这个类的时候，添加监听`SIM`卡状态列表中，这样会监听底层对`SIM`状态变化的通知

```

    private UiccController(Context c, CommandsInterface []ci) {
        if (DBG) log("Creating UiccController");
        mContext = c;
        mCis = ci;
        for (int i = 0; i < mCis.length; i++) {
            Integer index = new Integer(i);
            mCis[i].registerForIccStatusChanged(this, EVENT_ICC_STATUS_CHANGED, index);

```

`frameworks/opt/telephony/src/java/com/android/internal/telephony/RIL.java`
中会主动上报`SIM`卡变化的通知

```
case RIL_UNSOL_RESPONSE_SIM_STATUS_CHANGED:
    if (RILJ_LOGD) unsljLog(response);

    if (mIccStatusChangedRegistrants != null) {
        mIccStatusChangedRegistrants.notifyRegistrants();
    }
    break;
```

监听到状态变化以后，会去主动查询`SIM`卡的状态

```
public void handleMessage (Message msg) {
    synchronized (mLock) {
        Integer index = getCiIndex(msg);

        if (index < 0 || index >= mCis.length) {
            Rlog.e(LOG_TAG, "Invalid index : " + index + " received with event " + msg.what);
            return;
        }

        AsyncResult ar = (AsyncResult)msg.obj;
        switch (msg.what) {
            case EVENT_ICC_STATUS_CHANGED:
                if (DBG) log("Received EVENT_ICC_STATUS_CHANGED, calling getIccCardStatus");
                mCis[index].getIccCardStatus(obtainMessage(EVENT_GET_ICC_STATUS_DONE, index));
                break;
```

查询到的信息在`EVENT_GET_ICC_STATUS_DONE`消息会反馈

```
case EVENT_GET_ICC_STATUS_DONE:
    if (DBG) log("Received EVENT_GET_ICC_STATUS_DONE");
    onGetIccCardStatusDone(ar, index);
    break;
```
