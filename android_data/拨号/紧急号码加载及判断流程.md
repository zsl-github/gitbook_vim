---
title: 紧急号码加载及判断流程
date: 2017-05-01 15:34:38
tags: android
categories:
    - 拨号
    - 紧急号码
password: 
---

之前有学习过紧急号码预制方法，我们这里再学习下紧急号码在代码中的加载以及判断逻辑

# 紧急号码判断

在类`frameworks/base/telephony/java/android/telephony/PhoneNumberUtils.java`进行号码判断

```java
private static boolean isEmergencyNumberInternal(int subId, String number,
                                                 String defaultCountryIso,
                                                 boolean useExactMatch) {
    // If the number passed in is a SIP address, return false, since the
    // concept of "emergency numbers" is only meaningful for calls placed
    // over the cell network.
    // (Be sure to do this check *before* calling extractNetworkPortionAlt(),
    // since the whole point of extractNetworkPortionAlt() is to filter out
    // any non-dialable characters (which would turn 'abc911def@example.com'
    // into '911', for example.))
    if (isUriNumber(number)) {
        return false;
    }

    // Strip the separators from the number before comparing it
    // to the list.
    number = extractNetworkPortionAlt(number);

    String emergencyNumbers = "";
    int slotId = SubscriptionManager.getSlotId(subId);

    // retrieve the list of emergency numbers
    // check read-write ecclist property first
    String ecclist = (slotId <= 0) ? "ril.ecclist" : ("ril.ecclist" + slotId);

    emergencyNumbers = SystemProperties.get(ecclist, "");

    Rlog.d(LOG_TAG, "slotId:" + slotId + " subId:" + subId + " country:"
            + defaultCountryIso + " emergencyNumbers: " +  emergencyNumbers);

    if (TextUtils.isEmpty(emergencyNumbers)) {
        // then read-only ecclist property since old RIL only uses this
        emergencyNumbers = SystemProperties.get("ro.ril.ecclist");
    }

    if (!TextUtils.isEmpty(emergencyNumbers)) {
        // searches through the comma-separated list for a match,
        // return true if one is found.
        for (String emergencyNum : emergencyNumbers.split(",")) {
            // It is not possible to append additional digits to an emergency number to dial
            // the number in Brazil - it won't connect.
            if (useExactMatch || "BR".equalsIgnoreCase(defaultCountryIso)) {
                if (number.equals(emergencyNum)) {
                    return true;
                }
            } else {
                if (number.startsWith(emergencyNum)) {
                    return true;
                }
            }
        }
        // no matches found against the list!
        return false;
    }

    Rlog.d(LOG_TAG, "System property doesn't provide any emergency numbers."
            + " Use embedded logic for determining ones.");

    // If slot id is invalid, means that there is no sim card.
    // According spec 3GPP TS22.101, the following numbers should be
    // ECC numbers when SIM/USIM is not present.
    emergencyNumbers = ((slotId < 0) ? "112,911,000,08,110,118,119,999" : "112,911");

    for (String emergencyNum : emergencyNumbers.split(",")) {
        if (useExactMatch) {
            if (number.equals(emergencyNum)) {
                return true;
            }
        } else {
            if (number.startsWith(emergencyNum)) {
                return true;
            }
        }
    }

    // No ecclist system property, so use our own list.
    if (defaultCountryIso != null) {
        ShortNumberUtil util = new ShortNumberUtil();
        if (useExactMatch) {
            return util.isEmergencyNumber(number, defaultCountryIso);
        } else {
            return util.connectsToEmergencyNumber(number, defaultCountryIso);
        }
    }

    return false;
}
```

